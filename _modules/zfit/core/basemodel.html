
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>zfit.core.basemodel &#8212; zfit 0.5.6.dev1+g72a8210 documentation</title>
    
  <link rel="stylesheet" href="../../../_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../../../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../../../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css" />
    
  <link rel="preload" as="script" href="../../../_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../../_static/zfit-favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main">
<div class="container-xl">

    <a class="navbar-brand" href="../../../index.html">
    
      <img src="../../../_static/zfit-logo-light_400x168.png" class="logo" alt="logo" />
    
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar-menu" class="col-lg-9 collapse navbar-collapse">
      <ul id="navbar-main-elements" class="navbar-nav mr-auto">
        
        
        <li class="nav-item ">
            <a class="nav-link" href="../../../whats_new/index.html">Whatâ€™s new?</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../../getting_started/index.html">Getting started</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../../user_api/index.html">API reference</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../../project/index.html">Project</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../../ask_a_question.html">Ask a question</a>
        </li>
        
        
      </ul>


      

      <ul class="navbar-nav">
        
          <li class="nav-item">
            <a class="nav-link" href="https://github.com/zfit/zfit" target="_blank" rel="noopener">
              <span><i class="fab fa-github-square"></i></span>
            </a>
          </li>
        
        
      </ul>
    </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
          <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search zfit..." aria-label="Search zfit..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">

    <div class="bd-toc-item active">
    
  
    <ul class="nav bd-sidenav">
        
        
        
        
        
        
        
        
        
        
        
      </ul>
  
  </nav>
          </div>
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
              

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
    </ul>
</nav>


              
          </div>
          

          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <h1>Source code for zfit.core.basemodel</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Baseclass for a Model. Handle integration and sampling&quot;&quot;&quot;</span>

<span class="c1">#  Copyright (c) 2020 zfit</span>

<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">builtins</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">suppress</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow_probability.python</span> <span class="kn">import</span> <span class="n">mcmc</span> <span class="k">as</span> <span class="n">mc</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">integration</span> <span class="k">as</span> <span class="n">zintegrate</span><span class="p">,</span> <span class="n">sample</span> <span class="k">as</span> <span class="n">zsample</span>
<span class="kn">from</span> <span class="nn">.baseobject</span> <span class="kn">import</span> <span class="n">BaseNumeric</span>
<span class="kn">from</span> <span class="nn">.data</span> <span class="kn">import</span> <span class="n">Data</span><span class="p">,</span> <span class="n">Sampler</span><span class="p">,</span> <span class="n">SampleData</span>
<span class="kn">from</span> <span class="nn">.dependents</span> <span class="kn">import</span> <span class="n">_extract_dependencies</span>
<span class="kn">from</span> <span class="nn">.dimension</span> <span class="kn">import</span> <span class="n">BaseDimensional</span>
<span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">ZfitModel</span><span class="p">,</span> <span class="n">ZfitParameter</span><span class="p">,</span> <span class="n">ZfitData</span><span class="p">,</span> <span class="n">ZfitSpace</span>
<span class="kn">from</span> <span class="nn">.sample</span> <span class="kn">import</span> <span class="n">UniformSampleAndWeights</span>
<span class="kn">from</span> <span class="nn">.space</span> <span class="kn">import</span> <span class="n">Space</span><span class="p">,</span> <span class="n">convert_to_space</span><span class="p">,</span> <span class="n">no_norm_range</span><span class="p">,</span> <span class="n">supports</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">z</span>
<span class="kn">from</span> <span class="nn">..core.integration</span> <span class="kn">import</span> <span class="n">Integration</span>
<span class="kn">from</span> <span class="nn">..settings</span> <span class="kn">import</span> <span class="n">ztypes</span>
<span class="kn">from</span> <span class="nn">..util</span> <span class="kn">import</span> <span class="n">container</span> <span class="k">as</span> <span class="n">zcontainer</span><span class="p">,</span> <span class="n">ztyping</span>
<span class="kn">from</span> <span class="nn">..util.cache</span> <span class="kn">import</span> <span class="n">GraphCachable</span>
<span class="kn">from</span> <span class="nn">..util.exception</span> <span class="kn">import</span> <span class="p">(</span><span class="n">BasePDFSubclassingError</span><span class="p">,</span> <span class="n">MultipleLimitsNotImplementedError</span><span class="p">,</span> <span class="n">NormRangeNotImplementedError</span><span class="p">,</span>
                              <span class="n">ShapeIncompatibleError</span><span class="p">,</span> <span class="n">SubclassingError</span><span class="p">,</span> <span class="n">CannotConvertToNumpyError</span><span class="p">,</span> <span class="n">WorkInProgressError</span><span class="p">,</span>
                              <span class="n">SpaceIncompatibleError</span><span class="p">,</span> <span class="n">AnalyticIntegralNotImplementedError</span><span class="p">,</span>
                              <span class="n">SpecificFunctionNotImplementedError</span><span class="p">,</span>
                              <span class="n">AnalyticSamplingNotImplementedError</span><span class="p">,</span> <span class="n">FunctionNotImplementedError</span><span class="p">)</span>

<span class="n">_BaseModel_USER_IMPL_METHODS_TO_CHECK</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">def</span> <span class="nf">_BaseModel_register_check_support</span><span class="p">(</span><span class="n">has_support</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Marks a method that the subclass either *has* to or *can&#39;t* use the `@supports` decorator.</span>

<span class="sd">    Args:</span>
<span class="sd">        has_support: If True, flags that it **requires** the `@supports` decorator. If False,</span>
<span class="sd">            flags that the `@supports` decorator is **not allowed**.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">has_support</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Has to be boolean.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a method to be checked to (if True) *has* `support` or (if False) has *no* `support`.</span>

<span class="sd">        Args:</span>
<span class="sd">            func:</span>

<span class="sd">        Returns:</span>
<span class="sd">            Function:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">_BaseModel_USER_IMPL_METHODS_TO_CHECK</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">has_support</span>
        <span class="n">func</span><span class="o">.</span><span class="n">__wrapped__</span> <span class="o">=</span> <span class="n">_BaseModel_register_check_support</span>
        <span class="k">return</span> <span class="n">func</span>

    <span class="k">return</span> <span class="n">register</span>


<div class="viewcode-block" id="BaseModel"><a class="viewcode-back" href="../../../full_api/zfit.core.basemodel.html#zfit.core.basefunc.BaseModel">[docs]</a><span class="k">class</span> <span class="nc">BaseModel</span><span class="p">(</span><span class="n">BaseNumeric</span><span class="p">,</span> <span class="n">GraphCachable</span><span class="p">,</span> <span class="n">BaseDimensional</span><span class="p">,</span> <span class="n">ZfitModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for any generic model.</span>

<span class="sd">    # TODO instructions on how to use</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_DEFAULTS_integration</span> <span class="o">=</span> <span class="n">zcontainer</span><span class="o">.</span><span class="n">DotDict</span><span class="p">()</span>
    <span class="n">_DEFAULTS_integration</span><span class="o">.</span><span class="n">mc_sampler</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">mc</span><span class="o">.</span><span class="n">sample_halton_sequence</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">randomized</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                                                         <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c1"># _DEFAULTS_integration.mc_sampler = lambda dim, num_results, dtype: tf.random_uniform(maxval=1.,</span>
    <span class="c1">#                                                                                      shape=(num_results, dim),</span>
    <span class="c1">#                                                                                      dtype=dtype)</span>
    <span class="n">_DEFAULTS_integration</span><span class="o">.</span><span class="n">draws_per_dim</span> <span class="o">=</span> <span class="mi">40000</span>
    <span class="n">_DEFAULTS_integration</span><span class="o">.</span><span class="n">auto_numeric_integrator</span> <span class="o">=</span> <span class="n">zintegrate</span><span class="o">.</span><span class="n">auto_integrate</span>

    <span class="n">_analytic_integral</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_inverse_analytic_integral</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_additional_repr</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">ObsTypeInput</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ZfitParameter</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;BaseModel&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">ztypes</span><span class="o">.</span><span class="n">float</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The base model to inherit from and overwrite `_unnormalized_pdf`.</span>

<span class="sd">        Args:</span>
<span class="sd">            dtype: the dtype of the model</span>
<span class="sd">            name: the name of the model</span>
<span class="sd">            params: A dictionary with the internal name of the parameter and</span>
<span class="sd">                the parameters itself the model depends on</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_set_space</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_integration</span> <span class="o">=</span> <span class="n">zcontainer</span><span class="o">.</span><span class="n">DotDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_integration</span><span class="o">.</span><span class="n">auto_numeric_integrator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULTS_integration</span><span class="o">.</span><span class="n">auto_numeric_integrator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integration</span> <span class="o">=</span> <span class="n">Integration</span><span class="p">(</span><span class="n">mc_sampler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULTS_integration</span><span class="o">.</span><span class="n">mc_sampler</span><span class="p">,</span>
                                       <span class="n">draws_per_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULTS_integration</span><span class="o">.</span><span class="n">draws_per_dim</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sample_and_weights</span> <span class="o">=</span> <span class="n">UniformSampleAndWeights</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># check if subclass has decorator if required</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_subclass_check_support</span><span class="p">(</span><span class="n">methods_to_check</span><span class="o">=</span><span class="n">_BaseModel_USER_IMPL_METHODS_TO_CHECK</span><span class="p">,</span>
                                    <span class="n">wrapper_not_overwritten</span><span class="o">=</span><span class="n">_BaseModel_register_check_support</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_analytic_integral</span> <span class="o">=</span> <span class="n">zintegrate</span><span class="o">.</span><span class="n">AnalyticIntegral</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_inverse_analytic_integral</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_additional_repr</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_subclass_check_support</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">methods_to_check</span><span class="p">,</span> <span class="n">wrapper_not_overwritten</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">method_name</span><span class="p">,</span> <span class="n">has_support</span> <span class="ow">in</span> <span class="n">methods_to_check</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">method_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s2">&quot;__wrapped__&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">__wrapped__</span> <span class="o">==</span> <span class="n">wrapper_not_overwritten</span><span class="p">:</span>
                    <span class="k">continue</span>  <span class="c1"># not overwritten, fine</span>

            <span class="c1"># here means: overwritten</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s2">&quot;__wrapped__&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">__wrapped__</span> <span class="o">==</span> <span class="n">supports</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">has_support</span><span class="p">:</span>
                        <span class="k">continue</span>  <span class="c1"># needs support, has been wrapped</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">BasePDFSubclassingError</span><span class="p">(</span><span class="s2">&quot;Method </span><span class="si">{}</span><span class="s2"> has been wrapped with supports &quot;</span>
                                                      <span class="s2">&quot;but is not allowed to. Has to handle all &quot;</span>
                                                      <span class="s2">&quot;arguments.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method_name</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">has_support</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">BasePDFSubclassingError</span><span class="p">(</span><span class="s2">&quot;Method </span><span class="si">{}</span><span class="s2"> has been overwritten and *has to* be &quot;</span>
                                                  <span class="s2">&quot;wrapped by `supports` decorator (don&#39;t forget () )&quot;</span>
                                                  <span class="s2">&quot;to call the decorator as it takes arguments&quot;</span>
                                                  <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method_name</span><span class="p">))</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">has_support</span><span class="p">:</span>
                    <span class="k">continue</span>  <span class="c1"># no support, has not been wrapped with</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">has_support</span><span class="p">:</span>
                    <span class="k">continue</span>  <span class="c1"># not wrapped, no support, need no</span>

            <span class="c1"># if we reach this points, somethings was implemented wrongly</span>
            <span class="k">raise</span> <span class="n">BasePDFSubclassingError</span><span class="p">(</span><span class="s2">&quot;Method </span><span class="si">{}</span><span class="s2"> has not been correctly wrapped with @supports &quot;</span>
                                          <span class="s2">&quot;OR has been wrapped but it should not be&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method_name</span><span class="p">))</span>

    <span class="c1"># since subclasses can be funcs of pdfs, we need to now what to sample/integrate from</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_func_to_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">XType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_func_to_sample_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">XType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Data</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">space</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ZfitSpace</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_space</span>

    <span class="k">def</span> <span class="nf">_check_set_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">ZfitSpace</span><span class="p">):</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="n">Space</span><span class="p">(</span><span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_n_obs</span><span class="p">(</span><span class="n">space</span><span class="o">=</span><span class="n">obs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_space</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">with_autofill_axes</span><span class="p">(</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">_convert_sort_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">XTypeInput</span><span class="p">,</span> <span class="n">partial</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Data</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ZfitData</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">x</span><span class="o">.</span><span class="n">sort_by_obs</span><span class="p">(</span><span class="n">obs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span> <span class="n">allow_superset</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">x</span>
            <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">axes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">x</span><span class="o">.</span><span class="n">sort_by_axes</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">x</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Neither the `obs` nor the `axes` are specified in `Data`&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">convert_to_tensor</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrong type of x (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2">). Has to be a `Data` or convertible to a tf.Tensor&quot;</span><span class="p">)</span>
            <span class="c1"># check dimension</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_dim_to_x</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x_shape</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">as_list</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">partial</span> <span class="ow">and</span> <span class="n">x_shape</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_obs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ShapeIncompatibleError</span><span class="p">(</span><span class="s2">&quot;The shape of x (=</span><span class="si">{}</span><span class="s2">) (in the last dim) does not&quot;</span>
                                             <span class="s2">&quot;match the shape (=</span><span class="si">{}</span><span class="s2">)of the model&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x_shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_obs</span><span class="p">))</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">Data</span><span class="o">.</span><span class="n">from_tensor</span><span class="p">(</span><span class="n">obs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span> <span class="n">tensor</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">_add_dim_to_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>  <span class="c1"># TODO(Mayou36): remove function? unnecessary? dealt with in `Data`?</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_obs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">as_list</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">as_list</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

<div class="viewcode-block" id="BaseModel.update_integration_options"><a class="viewcode-back" href="../../../full_api/zfit.core.basemodel.html#zfit.core.basefunc.BaseModel.update_integration_options">[docs]</a>    <span class="k">def</span> <span class="nf">update_integration_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">draws_per_dim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mc_sampler</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the integration options.</span>

<span class="sd">        Args:</span>
<span class="sd">            draws_per_dim: The draws for MC integration to do</span>
<span class="sd">            mc_sampler:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># mc_options = {} if mc_options is None else mc_options</span>
        <span class="c1"># numeric_options = {} if numeric_options is None else numeric_options</span>
        <span class="c1"># general_options = {} if general_options is None else general_options</span>
        <span class="c1"># analytic_options = {} if analytic_options is None else analytic_options</span>
        <span class="c1"># if analytic_options:</span>
        <span class="c1">#     raise NotImplementedError(&quot;analytic_options cannot be updated currently.&quot;)</span>
        <span class="k">if</span> <span class="n">draws_per_dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">draws_per_dim</span> <span class="o">=</span> <span class="n">draws_per_dim</span>
        <span class="k">if</span> <span class="n">mc_sampler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">mc_sampler</span> <span class="o">=</span> <span class="n">mc_sampler</span></div>

    <span class="c1"># TODO: remove below? or add &quot;analytic gradients&quot;?</span>
<div class="viewcode-block" id="BaseModel.gradients"><a class="viewcode-back" href="../../../full_api/zfit.core.basemodel.html#zfit.core.basefunc.BaseModel.gradients">[docs]</a>    <span class="k">def</span> <span class="nf">gradients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">XType</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">LimitsType</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">ParamsTypeOpt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Are the gradients needed?&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_check_input_norm_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">,</span> <span class="n">none_is_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ZfitSpace</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Convert to :py:class:`~zfit.Space`.</span>

<span class="sd">        Args:</span>
<span class="sd">            norm_range:</span>
<span class="sd">            none_is_error: if both `norm_range` and `self.norm_range` are None, the default</span>
<span class="sd">                value is `False` (meaning: no range specified-&gt; no normalization to be done). If</span>
<span class="sd">                this is set to true, two `None` will raise a Value error.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[:py:class:`~zfit.Space`, False]:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">norm_range</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">norm_range</span><span class="p">,</span> <span class="n">ZfitSpace</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">norm_range</span><span class="o">.</span><span class="n">limits_are_set</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">none_is_error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Normalization range `norm_range` has to be specified or&quot;</span>
                                 <span class="s2">&quot;a default normalization range has to be set. Currently, both are None&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_sort_space</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_input_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">none_is_error</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">limits</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">limits</span><span class="p">,</span> <span class="n">ZfitSpace</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">limits</span><span class="o">.</span><span class="n">has_limits</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">none_is_error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The `limits` have to be specified and not be None&quot;</span><span class="p">)</span>
            <span class="c1"># else:</span>
            <span class="c1">#     limits = False</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_sort_space</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>

<div class="viewcode-block" id="BaseModel.convert_sort_space"><a class="viewcode-back" href="../../../full_api/zfit.core.basemodel.html#zfit.core.basefunc.BaseModel.convert_sort_space">[docs]</a>    <span class="k">def</span> <span class="nf">convert_sort_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ztyping</span><span class="o">.</span><span class="n">ObsTypeInput</span><span class="p">,</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">LimitsTypeInput</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">axes</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">AxesTypeInput</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">limits</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">LimitsTypeInput</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">ZfitSpace</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Convert the inputs (using eventually `obs`, `axes`) to :py:class:`~zfit.ZfitSpace` and sort them according to</span>
<span class="sd">        own `obs`.</span>

<span class="sd">        Args:</span>
<span class="sd">            obs:</span>
<span class="sd">            axes:</span>
<span class="sd">            limits:</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># for simple limits to convert them</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SpaceIncompatibleError</span><span class="p">(</span><span class="s2">&quot;The given space </span><span class="si">{obs}</span><span class="s2"> is not compatible with the obs of the pdfs</span><span class="si">{self.obs}</span><span class="s2">;&quot;</span>
                                         <span class="s2">&quot; they are disjoint.&quot;</span><span class="p">)</span>
        <span class="n">space</span> <span class="o">=</span> <span class="n">convert_to_space</span><span class="p">(</span><span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">space</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># e.g. not the first call</span>
            <span class="n">space</span> <span class="o">=</span> <span class="n">space</span><span class="o">.</span><span class="n">with_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="p">,</span> <span class="n">allow_superset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_subset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">space</span></div>

    <span class="c1"># Integrals</span>

    <span class="nd">@_BaseModel_register_check_support</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SpecificFunctionNotImplementedError</span>

    <span class="nd">@z</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">wraps</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">LimitsType</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">LimitsType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">XType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Integrate the function over `limits` (normalized over `norm_range` if not False).</span>

<span class="sd">        Args:</span>
<span class="sd">            limits: the limits to integrate over</span>
<span class="sd">            norm_range: the limits to normalize over or False to integrate the</span>
<span class="sd">                unnormalized probability</span>

<span class="sd">        Returns:</span>
<span class="sd">            The integral value as a scalar with shape ()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">norm_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_input_norm_range</span><span class="p">(</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_input_limits</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>
        <span class="n">integral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_hook_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="c1"># TODO: allow integral values as arrays?</span>
        <span class="c1"># if isinstance(integral, tf.Tensor):</span>
        <span class="c1">#     if not integral.shape.as_list() == []:</span>
        <span class="c1">#         raise ShapeIncompatibleError(&quot;Error in integral creation, should return an integral &quot;</span>
        <span class="c1">#                                      &quot;with shape () (resp. [] as list), current shape &quot;</span>
        <span class="c1">#                                      &quot;{}. If you registered an analytic integral which is used&quot;</span>
        <span class="c1">#                                      &quot;now, make sure to return a scalar and not a tensor &quot;</span>
        <span class="c1">#                                      &quot;(typically: shape is (1,) insead of () -&gt; return tensor[0] &quot;</span>
        <span class="c1">#                                      &quot;instead of tensor)&quot;.format(integral.shape.as_list()))</span>
        <span class="k">return</span> <span class="n">integral</span>

    <span class="k">def</span> <span class="nf">_single_hook_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hook_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_hook_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_norm_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limits_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">NormRangeNotImplementedError</span><span class="p">:</span>
            <span class="n">unnormalized_integral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limits_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">normalization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limits_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">norm_range</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="n">unnormalized_integral</span> <span class="o">/</span> <span class="n">normalization</span>
        <span class="k">return</span> <span class="n">integral</span>

    <span class="k">def</span> <span class="nf">_limits_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">MultipleLimitsNotImplementedError</span><span class="p">:</span>
            <span class="n">integrals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sub_limits</span> <span class="ow">in</span> <span class="n">limits</span><span class="p">:</span>
                <span class="n">integrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_call_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">sub_limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">))</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">integrals</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># TODO: remove stack?</span>
        <span class="k">return</span> <span class="n">integral</span>

    <span class="k">def</span> <span class="nf">_call_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>

        <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="n">FunctionNotImplementedError</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="n">AnalyticIntegralNotImplementedError</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hook_analytic_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fallback_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fallback_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">limits</span><span class="o">.</span><span class="n">axes</span>
        <span class="n">max_axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analytic_integral</span><span class="o">.</span><span class="n">get_max_axes</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span>

        <span class="n">integral</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">max_axes</span> <span class="ow">and</span> <span class="n">integral</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># TODO improve handling of available analytic integrals</span>
            <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="n">AnalyticIntegralNotImplementedError</span><span class="p">):</span>
                <span class="k">def</span> <span class="nf">part_int</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                    <span class="sd">&quot;&quot;&quot;Temporary partial integration function.&quot;&quot;&quot;</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hook_partial_analytic_integrate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>

                <span class="n">integral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_numeric_integrate</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">part_int</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">integral</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hook_numeric_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">integral</span>

<div class="viewcode-block" id="BaseModel.register_analytic_integral"><a class="viewcode-back" href="../../../full_api/zfit.core.basemodel.html#zfit.core.basefunc.BaseModel.register_analytic_integral">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">register_analytic_integral</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">limits</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">LimitsType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                   <span class="n">priority</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                                   <span class="n">supports_norm_range</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                   <span class="n">supports_multiple_limits</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Register an analytic integral with the class.</span>

<span class="sd">        Args:</span>
<span class="sd">            func: A function that calculates the (partial) integral over the axes `limits`.</span>
<span class="sd">                The signature has to be the following:</span>

<span class="sd">                    * x (:py:class:`~zfit.core.interfaces.ZfitData`, None): the data for the remaining axes in a partial</span>
<span class="sd">                        integral. If it is not a partial integral, this will be None.</span>
<span class="sd">                    * limits (:py:class:`~zfit.ZfitSpace`): the limits to integrate over.</span>
<span class="sd">                    * norm_range (:py:class:`~zfit.ZfitSpace`, None): Normalization range of the integral.</span>
<span class="sd">                        If not `supports_supports_norm_range`, this will be None.</span>
<span class="sd">                    * params (Dict[param_name, :py:class:`zfit.Parameters`]): The parameters of the model.</span>
<span class="sd">                    * model (:py:class:`~zfit.core.interfaces.ZfitModel`):The model that is being integrated.</span>

<span class="sd">            limits: |limits_arg_descr|</span>
<span class="sd">            priority: Priority of the function. If multiple functions cover the same space, the one with the</span>
<span class="sd">                highest priority will be used.</span>
<span class="sd">            supports_multiple_limits: If `True`, the `limits` given to the integration function can have</span>
<span class="sd">                multiple limits. If `False`, only simple limits will pass through and multiple limits will be</span>
<span class="sd">                auto-handled.</span>
<span class="sd">            supports_norm_range: If `True`, `norm_range` argument to the function may not be `None`.</span>
<span class="sd">                If `False`, `norm_range` will always be `None` and care is taken of the normalization automatically.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_analytic_integral</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">supports_norm_range</span><span class="o">=</span><span class="n">supports_norm_range</span><span class="p">,</span>
                                        <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span> <span class="n">supports_multiple_limits</span><span class="o">=</span><span class="n">supports_multiple_limits</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseModel.register_inverse_analytic_integral"><a class="viewcode-back" href="../../../full_api/zfit.core.basemodel.html#zfit.core.basefunc.BaseModel.register_inverse_analytic_integral">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">register_inverse_analytic_integral</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Register an inverse analytical integral, the inverse (unnormalized) cdf.</span>

<span class="sd">        Args:</span>
<span class="sd">            func: A function with the signature `func(x, params)`, where `x` is a Data object</span>
<span class="sd">                and `params` is a dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_inverse_analytic_integral</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_inverse_analytic_integral</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_inverse_analytic_integral</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">)</span></div>

    <span class="nd">@_BaseModel_register_check_support</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_analytic_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SpecificFunctionNotImplementedError</span>

<div class="viewcode-block" id="BaseModel.analytic_integrate"><a class="viewcode-back" href="../../../full_api/zfit.core.basemodel.html#zfit.core.basefunc.BaseModel.analytic_integrate">[docs]</a>    <span class="k">def</span> <span class="nf">analytic_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">LimitsType</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">LimitsType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">XType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Analytical integration over function and raise Error if not possible.</span>

<span class="sd">        Args:</span>
<span class="sd">            limits: the limits to integrate over</span>
<span class="sd">            norm_range: the limits to normalize over</span>

<span class="sd">        Returns:</span>
<span class="sd">            The integral value</span>
<span class="sd">        Raises:</span>
<span class="sd">            AnalyticIntegralNotImplementedError: If no analytical integral is available (for this limits).</span>
<span class="sd">            NormRangeNotImplementedError: if the *norm_range* argument is not supported. This</span>
<span class="sd">                means that no analytical normalization is available, explicitly: the **analytical**</span>
<span class="sd">                integral over the limits = norm_range is not available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">norm_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_input_norm_range</span><span class="p">(</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_input_limits</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_hook_analytic_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_single_hook_analytic_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hook_analytic_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_hook_analytic_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_analytic_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_norm_analytic_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limits_analytic_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">NormRangeNotImplementedError</span><span class="p">:</span>

            <span class="n">unnormalized_integral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limits_analytic_integrate</span><span class="p">(</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">normalization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limits_analytic_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">norm_range</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">AnalyticIntegralNotImplementedError</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">NormRangeNotImplementedError</span><span class="p">(</span><span class="s2">&quot;Function does not support this (or even any)&quot;</span>
                                                   <span class="s2">&quot;normalization range &#39;norm_range&#39;.&quot;</span>
                                                   <span class="s2">&quot; This usually means,that no analytic integral &quot;</span>
                                                   <span class="s2">&quot;is available for this function. Due to rule &quot;</span>
                                                   <span class="s2">&quot;safety, an analytical normalization has to &quot;</span>
                                                   <span class="s2">&quot;be available and no attempt of numerical &quot;</span>
                                                   <span class="s2">&quot;normalization was made.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">integral</span> <span class="o">=</span> <span class="n">unnormalized_integral</span> <span class="o">/</span> <span class="n">normalization</span>
        <span class="k">return</span> <span class="n">integral</span>

    <span class="k">def</span> <span class="nf">_limits_analytic_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_analytic_integrate</span><span class="p">(</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">MultipleLimitsNotImplementedError</span><span class="p">:</span>
            <span class="n">integrals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sub_limits</span> <span class="ow">in</span> <span class="n">limits</span><span class="p">:</span>
                <span class="n">integrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_call_analytic_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">sub_limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">))</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">integrals</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">integral</span>

    <span class="k">def</span> <span class="nf">_call_analytic_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="n">FunctionNotImplementedError</span><span class="p">,</span> <span class="n">AnalyticIntegralNotImplementedError</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analytic_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fallback_analytic_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fallback_analytic_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analytic_integral</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">limits</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span>
                                                     <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">SpecificFunctionNotImplementedError</span><span class="p">,</span> <span class="n">AnalyticIntegralNotImplementedError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">AnalyticIntegralNotImplementedError</span>

    <span class="nd">@_BaseModel_register_check_support</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_numeric_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SpecificFunctionNotImplementedError</span>

<div class="viewcode-block" id="BaseModel.numeric_integrate"><a class="viewcode-back" href="../../../full_api/zfit.core.basemodel.html#zfit.core.basefunc.BaseModel.numeric_integrate">[docs]</a>    <span class="k">def</span> <span class="nf">numeric_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">LimitsType</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">LimitsType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">XType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Numerical integration over the model.</span>

<span class="sd">        Args:</span>
<span class="sd">            limits: the limits to integrate over</span>
<span class="sd">            norm_range: the limits to normalize over</span>

<span class="sd">        Returns:</span>
<span class="sd">            The integral value</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">norm_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_input_norm_range</span><span class="p">(</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_input_limits</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_hook_numeric_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_single_hook_numeric_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hook_numeric_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_hook_numeric_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_numeric_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_norm_numeric_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limits_numeric_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">NormRangeNotImplementedError</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">norm_range</span><span class="o">.</span><span class="n">limits_are_false</span><span class="p">,</span> <span class="s2">&quot;Internal: the caught Error should not be raised.&quot;</span>
            <span class="n">unnormalized_integral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limits_numeric_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">normalization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limits_numeric_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">norm_range</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="n">unnormalized_integral</span> <span class="o">/</span> <span class="n">normalization</span>
        <span class="k">return</span> <span class="n">integral</span>

    <span class="k">def</span> <span class="nf">_limits_numeric_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_numeric_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">MultipleLimitsNotImplementedError</span><span class="p">:</span>
            <span class="n">integrals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sub_limits</span> <span class="ow">in</span> <span class="n">limits</span><span class="p">:</span>
                <span class="n">integrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_call_numeric_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">sub_limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">))</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">integrals</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">integral</span>

    <span class="k">def</span> <span class="nf">_call_numeric_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="n">FunctionNotImplementedError</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numeric_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fallback_numeric_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fallback_numeric_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_numeric_integrate</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_func_to_integrate</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>

    <span class="nd">@_BaseModel_register_check_support</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_partial_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SpecificFunctionNotImplementedError</span>

    <span class="nd">@z</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">wraps</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">partial_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">XTypeInput</span><span class="p">,</span> <span class="n">limits</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">LimitsType</span><span class="p">,</span>
                          <span class="n">norm_range</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">LimitsType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">XTypeReturn</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Partially integrate the function over the `limits` and evaluate it at `x`.</span>

<span class="sd">        Dimension of `limits` and `x` have to add up to the full dimension and be therefore equal</span>
<span class="sd">        to the dimensions of `norm_range` (if not False)</span>

<span class="sd">        Args:</span>
<span class="sd">            x: The value at which the partially integrated function will be evaluated</span>
<span class="sd">            limits: the limits to integrate over. Can contain only some axes</span>
<span class="sd">            norm_range: the limits to normalize over. Has to have all axes</span>

<span class="sd">        Returns:</span>
<span class="sd">            The value of the partially integrated function evaluated at `x`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">norm_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_input_norm_range</span><span class="p">(</span><span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_input_limits</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_sort_x</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">partial</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">x</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_hook_partial_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_single_hook_partial_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hook_partial_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_hook_partial_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="n">integral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_partial_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">integral</span>

    <span class="k">def</span> <span class="nf">_norm_partial_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limits_partial_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">NormRangeNotImplementedError</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">norm_range</span><span class="o">.</span><span class="n">limits_are_false</span><span class="p">,</span> <span class="s2">&quot;Internal: the caught Error should not be raised.&quot;</span>
            <span class="n">unnormalized_integral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limits_partial_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">normalization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hook_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">norm_range</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="n">unnormalized_integral</span> <span class="o">/</span> <span class="n">normalization</span>
        <span class="k">return</span> <span class="n">integral</span>

    <span class="k">def</span> <span class="nf">_limits_partial_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_partial_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">MultipleLimitsNotImplementedError</span><span class="p">:</span>
            <span class="n">integrals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sub_limit</span> <span class="ow">in</span> <span class="n">limits</span><span class="p">:</span>
                <span class="n">integrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_call_partial_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">sub_limit</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">))</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">integrals</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">integral</span>

    <span class="k">def</span> <span class="nf">_call_partial_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>

        <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="n">FunctionNotImplementedError</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partial_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="n">AnalyticIntegralNotImplementedError</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hook_partial_analytic_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fallback_partial_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">FunctionNotImplementedError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AnalyticIntegralNotImplementedError</span>

    <span class="k">def</span> <span class="nf">_fallback_partial_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="p">:</span> <span class="n">ZfitSpace</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">:</span> <span class="n">ZfitSpace</span><span class="p">):</span>
        <span class="n">max_axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analytic_integral</span><span class="o">.</span><span class="n">get_max_axes</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">limits</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_axes</span><span class="p">:</span>
            <span class="n">sublimits</span> <span class="o">=</span> <span class="n">limits</span><span class="o">.</span><span class="n">get_subspace</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">max_axes</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">part_int</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>  <span class="c1"># change to partial integrate max axes?</span>
                <span class="sd">&quot;&quot;&quot;Temporary partial integration function.&quot;&quot;&quot;</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hook_partial_analytic_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">sublimits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>

            <span class="n">axes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">limits</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">max_axes</span><span class="p">))</span>
            <span class="n">limits</span> <span class="o">=</span> <span class="n">limits</span><span class="o">.</span><span class="n">get_subspace</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">part_int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_to_integrate</span>

        <span class="k">assert</span> <span class="n">limits</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="s2">&quot;Internal Error! Axes should not be empty, maybe cleanup.&quot;</span>
        <span class="n">integral_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_numeric_integrate</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">part_int</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">integral_vals</span>

    <span class="nd">@_BaseModel_register_check_support</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_partial_analytic_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SpecificFunctionNotImplementedError</span>

    <span class="nd">@z</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">wraps</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">partial_analytic_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">XTypeInput</span><span class="p">,</span> <span class="n">limits</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">LimitsType</span><span class="p">,</span>
                                   <span class="n">norm_range</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">LimitsType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">XTypeReturn</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Do analytical partial integration of the function over the `limits` and evaluate it at `x`.</span>

<span class="sd">        Dimension of `limits` and `x` have to add up to the full dimension and be therefore equal</span>
<span class="sd">        to the dimensions of `norm_range` (if not False)</span>

<span class="sd">        Args:</span>
<span class="sd">            x: The value at which the partially integrated function will be evaluated</span>
<span class="sd">            limits: the limits to integrate over. Can contain only some axes</span>
<span class="sd">            norm_range: the limits to normalize over. Has to have all axes</span>

<span class="sd">        Returns:</span>
<span class="sd">            The value of the partially integrated function evaluated at `x`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            AnalyticIntegralNotImplementedError: if the *analytic* integral (over this limits) is not implemented</span>
<span class="sd">            NormRangeNotImplementedError: if the *norm_range* argument is not supported. This</span>
<span class="sd">                means that no analytical normalization is available, explicitly: the **analytical**</span>
<span class="sd">                integral over the limits = norm_range is not available.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">norm_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_input_norm_range</span><span class="p">(</span><span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_input_limits</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_sort_x</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">partial</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">x</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_hook_partial_analytic_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_single_hook_partial_analytic_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hook_partial_analytic_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_hook_partial_analytic_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_partial_analytic_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_norm_partial_analytic_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limits_partial_analytic_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">NormRangeNotImplementedError</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">norm_range</span><span class="o">.</span><span class="n">limits_are_false</span><span class="p">,</span> <span class="s2">&quot;Internal: the caught Error should not be raised.&quot;</span>
            <span class="n">unnormalized_integral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limits_partial_analytic_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">normalization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limits_analytic_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">norm_range</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">AnalyticIntegralNotImplementedError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NormRangeNotImplementedError</span><span class="p">(</span><span class="s2">&quot;Function does not support this (or even any) normalization range&quot;</span>
                                                   <span class="s2">&quot; &#39;norm_range&#39;. This usually means,that no analytic integral &quot;</span>
                                                   <span class="s2">&quot;is available for this function. An analytical normalization has to &quot;</span>
                                                   <span class="s2">&quot;be available and no attempt of numerical normalization was made.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">integral</span> <span class="o">=</span> <span class="n">unnormalized_integral</span> <span class="o">/</span> <span class="n">normalization</span>
        <span class="k">return</span> <span class="n">integral</span>

    <span class="k">def</span> <span class="nf">_limits_partial_analytic_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_partial_analytic_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">MultipleLimitsNotImplementedError</span><span class="p">:</span>
            <span class="n">integrals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sub_limits</span> <span class="ow">in</span> <span class="n">limits</span><span class="p">:</span>
                <span class="n">integrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_call_partial_analytic_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">sub_limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">))</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">integrals</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">integral</span>

    <span class="k">def</span> <span class="nf">_call_partial_analytic_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="n">FunctionNotImplementedError</span><span class="p">,</span> <span class="n">AnalyticIntegralNotImplementedError</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partial_analytic_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fallback_partial_analytic_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fallback_partial_analytic_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analytic_integral</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">limits</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span>
                                                     <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">SpecificFunctionNotImplementedError</span><span class="p">,</span> <span class="n">AnalyticIntegralNotImplementedError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">AnalyticIntegralNotImplementedError</span>

    <span class="nd">@_BaseModel_register_check_support</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_partial_numeric_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SpecificFunctionNotImplementedError</span>

    <span class="nd">@z</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">wraps</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">partial_numeric_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">XType</span><span class="p">,</span> <span class="n">limits</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">LimitsType</span><span class="p">,</span>
                                  <span class="n">norm_range</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">LimitsType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">XType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Force numerical partial integration of the function over the `limits` and evaluate it at `x`.</span>

<span class="sd">        Dimension of `limits` and `x` have to add up to the full dimension and be therefore equal</span>
<span class="sd">        to the dimensions of `norm_range` (if not False)</span>

<span class="sd">        Args:</span>
<span class="sd">            x: The value at which the partially integrated function will be evaluated</span>
<span class="sd">            limits: the limits to integrate over. Can contain only some axes</span>
<span class="sd">            norm_range: the limits to normalize over. Has to have all axes</span>

<span class="sd">        Returns:</span>
<span class="sd">            The value of the partially integrated function evaluated at `x`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">norm_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_input_norm_range</span><span class="p">(</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_input_limits</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_sort_x</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">partial</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">x</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_hook_partial_numeric_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_single_hook_partial_numeric_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hook_partial_numeric_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_hook_partial_numeric_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="n">integral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_partial_numeric_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">integral</span>

    <span class="k">def</span> <span class="nf">_norm_partial_numeric_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limits_partial_numeric_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">NormRangeNotImplementedError</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">norm_range</span><span class="o">.</span><span class="n">limits_are_false</span><span class="p">,</span> <span class="s2">&quot;Internal: the caught Error should not be raised.&quot;</span>
            <span class="n">unnormalized_integral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limits_partial_numeric_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="n">unnormalized_integral</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hook_numeric_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">norm_range</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">integral</span>

    <span class="k">def</span> <span class="nf">_limits_partial_numeric_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_partial_numeric_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">MultipleLimitsNotImplementedError</span><span class="p">:</span>
            <span class="n">integrals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sub_limits</span> <span class="ow">in</span> <span class="n">limits</span><span class="p">:</span>
                <span class="n">integrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_call_partial_numeric_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">sub_limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">))</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">integrals</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">integral</span>

    <span class="k">def</span> <span class="nf">_call_partial_numeric_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="n">SpecificFunctionNotImplementedError</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partial_numeric_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fallback_partial_numeric_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fallback_partial_numeric_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_numeric_integrate</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_func_to_integrate</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>

    <span class="nd">@no_norm_range</span>
    <span class="nd">@z</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">wraps</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_auto_numeric_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">overwrite_options</span><span class="p">):</span>
        <span class="n">integration_options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">n_axes</span><span class="o">=</span><span class="n">limits</span><span class="o">.</span><span class="n">n_obs</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="n">norm_range</span><span class="p">,</span>
                                   <span class="c1"># auto from self</span>
                                   <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                                   <span class="n">mc_sampler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">mc_sampler</span><span class="p">,</span>
                                   <span class="n">mc_options</span><span class="o">=</span><span class="p">{</span>
                                       <span class="s2">&quot;draws_per_dim&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">draws_per_dim</span><span class="p">},</span>
                                   <span class="o">**</span><span class="n">overwrite_options</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_integration</span><span class="o">.</span><span class="n">auto_numeric_integrator</span><span class="p">(</span><span class="o">**</span><span class="n">integration_options</span><span class="p">)</span>

    <span class="nd">@supports</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_inverse_analytic_integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inverse_analytic_integral</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AnalyticSamplingNotImplementedError</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">icdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inverse_analytic_integral</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">icdf</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">icdf</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">icdf</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;icdf function does not have the right signature: </span><span class="si">{</span><span class="n">icdf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="BaseModel.create_sampler"><a class="viewcode-back" href="../../../full_api/zfit.core.basemodel.html#zfit.core.basefunc.BaseModel.create_sampler">[docs]</a>    <span class="k">def</span> <span class="nf">create_sampler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">nSamplingTypeIn</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">limits</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">LimitsType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">fixed_params</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ZfitParameter</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ZfitParameter</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Sampler&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a :py:class:`Sampler` that acts as `Data` but can be resampled, also with changed parameters and n.</span>

<span class="sd">            If `limits` is not specified, `space` is used (if the space contains limits).</span>
<span class="sd">            If `n` is None and the model is an extended pdf, &#39;extended&#39; is used by default.</span>


<span class="sd">        Args:</span>
<span class="sd">            n: The number of samples to be generated. Can be a Tensor that will be</span>
<span class="sd">                or a valid string. Currently implemented:</span>

<span class="sd">                    - &#39;extended&#39;: samples `poisson(yield)` from each pdf that is extended.</span>

<span class="sd">            limits: From which space to sample.</span>
<span class="sd">            fixed_params: A list of `Parameters` that will be fixed during several `resample` calls.</span>
<span class="sd">                If True, all are fixed, if False, all are floating. If a :py:class:`~zfit.Parameter` is not fixed and</span>
<span class="sd">                its</span>
<span class="sd">                value gets updated (e.g. by a `Parameter.set_value()` call), this will be reflected in</span>
<span class="sd">                `resample`. If fixed, the Parameter will still have the same value as the `Sampler` has</span>
<span class="sd">                been created with when it resamples.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :py:class:~`zfit.core.data.Sampler`</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotExtendedPDFError: if &#39;extended&#39; is chosen (implicitly by default or explicitly) as an</span>
<span class="sd">                option for `n` but the pdf itself is not extended.</span>
<span class="sd">            ValueError: if n is an invalid string option.</span>
<span class="sd">            InvalidArgumentError: if n is not specified and pdf is not extended.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_input_limits</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">limits</span><span class="o">.</span><span class="n">limits_are_set</span><span class="p">:</span>
            <span class="n">limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">space</span>  <span class="c1"># TODO(Mayou36): clean up, better norm_range?</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">limits</span><span class="o">.</span><span class="n">has_limits</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;limits are False/None, have to be specified&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fixed_params</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">fixed_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cache_deps</span><span class="p">(</span><span class="n">only_floating</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">fixed_params</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">fixed_params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fixed_params</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;`Fixed_params` has to be a list, tuple or a boolean.&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">sample_func</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_sampler_tensor</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>

        <span class="n">sample_data</span> <span class="o">=</span> <span class="n">Sampler</span><span class="o">.</span><span class="n">from_sample</span><span class="p">(</span><span class="n">sample_func</span><span class="o">=</span><span class="n">sample_func</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">fixed_params</span><span class="o">=</span><span class="n">fixed_params</span><span class="p">,</span>
                                          <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sample_data</span></div>

    <span class="nd">@z</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">wraps</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_create_sampler_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>

        <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_hook_sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sample</span>

    <span class="nd">@_BaseModel_register_check_support</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">limits</span><span class="p">:</span> <span class="n">ZfitSpace</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SpecificFunctionNotImplementedError</span>

<div class="viewcode-block" id="BaseModel.sample"><a class="viewcode-back" href="../../../full_api/zfit.core.basemodel.html#zfit.core.basefunc.BaseModel.sample">[docs]</a>    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">nSamplingTypeIn</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">limits</span><span class="p">:</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">LimitsType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SampleData</span><span class="p">:</span>  <span class="c1"># TODO: change poissonian top-level with multinomial</span>
        <span class="sd">&quot;&quot;&quot;Sample `n` points within `limits` from the model.</span>

<span class="sd">        If `limits` is not specified, `space` is used (if the space contains limits).</span>
<span class="sd">        If `n` is None and the model is an extended pdf, &#39;extended&#39; is used by default.</span>

<span class="sd">        Args:</span>
<span class="sd">            n: The number of samples to be generated. Can be a Tensor that will be</span>
<span class="sd">                or a valid string. Currently implemented:</span>

<span class="sd">                    - &#39;extended&#39;: samples `poisson(yield)` from each pdf that is extended.</span>
<span class="sd">            limits: In which region to sample in</span>

<span class="sd">        Returns:</span>
<span class="sd">            SampleData(n_obs, n_samples)</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotExtendedPDFError: if &#39;extended&#39; is (implicitly by default or explicitly) chosen as an</span>
<span class="sd">                option for `n` but the pdf itself is not extended.</span>
<span class="sd">            ValueError: if n is an invalid string option.</span>
<span class="sd">            InvalidArgumentError: if n is not specified and pdf is not extended.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">convert_to_tensor</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="n">limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_input_limits</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">limits</span><span class="o">.</span><span class="n">limits_are_set</span><span class="p">:</span>
            <span class="n">limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">space</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">limits</span><span class="o">.</span><span class="n">has_limits</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">tf</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidArgumentError</span><span class="p">(</span><span class="s2">&quot;limits are False/None, have to be specified&quot;</span><span class="p">)</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_input_limits</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">none_is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="nd">@z</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">wraps</span><span class="o">=</span><span class="s1">&#39;model_sampling&#39;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">run_tf</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">limits</span><span class="p">):</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_hook_sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">sample</span>

        <span class="n">sample_data</span> <span class="o">=</span> <span class="n">SampleData</span><span class="o">.</span><span class="n">from_sample</span><span class="p">(</span><span class="n">sample</span><span class="o">=</span><span class="n">run_tf</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sample_data</span></div>

    <span class="k">def</span> <span class="nf">_single_hook_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">limits</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hook_sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_hook_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_norm_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">limits</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dummy function&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limits_sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_limits_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">limits</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">MultipleLimitsNotImplementedError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">total_integral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytic_integrate</span><span class="p">(</span><span class="n">limits</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">sub_integrals</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">analytic_integrate</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">norm_range</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">limit</span> <span class="ow">in</span> <span class="n">limits</span><span class="p">],</span>
                                          <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">AnalyticIntegralNotImplementedError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MultipleLimitsNotImplementedError</span><span class="p">(</span><span class="s2">&quot;Cannot autohandle multiple limits as the analytic&quot;</span>
                                                        <span class="s2">&quot; integral is not available.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">error</span>
            <span class="n">fracs</span> <span class="o">=</span> <span class="n">sub_integrals</span> <span class="o">/</span> <span class="n">total_integral</span>
            <span class="n">n_samples</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">counts_multinomial</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">fracs</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">samples</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">limit</span><span class="p">,</span> <span class="n">n_sample</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">limits</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">):</span>
                <span class="n">sub_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n_sample</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sub_sample</span><span class="p">,</span> <span class="n">ZfitData</span><span class="p">):</span>
                    <span class="n">sub_sample</span> <span class="o">=</span> <span class="n">sub_sample</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
                <span class="n">samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_sample</span><span class="p">)</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sample</span>

    <span class="k">def</span> <span class="nf">_call_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">limits</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="n">SpecificFunctionNotImplementedError</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="n">SpecificFunctionNotImplementedError</span><span class="p">,</span> <span class="n">AnalyticSamplingNotImplementedError</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analytic_sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fallback_sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_analytic_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">limits</span><span class="p">:</span> <span class="n">ZfitSpace</span><span class="p">):</span>  <span class="c1"># TODO(Mayou36) implement multiple limits sampling</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inverse_analytic_integral</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AnalyticSamplingNotImplementedError</span>  <span class="c1"># TODO(Mayou36): create proper analytic sampling</span>
        <span class="k">if</span> <span class="n">limits</span><span class="o">.</span><span class="n">n_limits</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AnalyticSamplingNotImplementedError</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">limits</span><span class="o">.</span><span class="n">rect_limits_np</span>
        <span class="k">except</span> <span class="n">CannotConvertToNumpyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WorkInProgressError</span><span class="p">(</span><span class="s2">&quot;Currently, analytic sampling with Tensors not supported.&quot;</span>
                                      <span class="s2">&quot; Needs implementation of analytic integrals with Tensors.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
        <span class="n">neg_infinities</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">((</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">),)</span> <span class="o">*</span> <span class="n">limits</span><span class="o">.</span><span class="n">n_obs</span><span class="p">),)</span>  <span class="c1"># py34 change float(&quot;inf&quot;) to math.inf</span>
        <span class="c1"># to the cdf to get the limits for the inverse analytic integral</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lower_prob_lim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_analytic_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">Space</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="n">neg_infinities</span><span class="p">,</span>
                                                                                <span class="p">(</span><span class="n">lower_bound</span><span class="p">,)),</span>
                                                                        <span class="n">axes</span><span class="o">=</span><span class="n">limits</span><span class="o">.</span><span class="n">axes</span><span class="p">),</span>
                                                           <span class="n">norm_range</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">upper_prob_lim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_analytic_integrate</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">Space</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="n">neg_infinities</span><span class="p">,</span>
                                                                                <span class="p">(</span><span class="n">upper_bound</span><span class="p">,)),</span>
                                                                        <span class="n">axes</span><span class="o">=</span><span class="n">limits</span><span class="o">.</span><span class="n">axes</span><span class="p">),</span>
                                                           <span class="n">norm_range</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">SpecificFunctionNotImplementedError</span><span class="p">,</span> <span class="n">AnalyticIntegralNotImplementedError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">AnalyticSamplingNotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;analytic sampling not possible because the analytic integral&quot;</span>
                                                      <span class="sa">f</span><span class="s2">&quot; is not&quot;&quot; implemented for the boundaries: </span><span class="si">{limits}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">prob_sample</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">limits</span><span class="o">.</span><span class="n">n_obs</span><span class="p">),</span> <span class="n">minval</span><span class="o">=</span><span class="n">lower_prob_lim</span><span class="p">,</span>
                                       <span class="n">maxval</span><span class="o">=</span><span class="n">upper_prob_lim</span><span class="p">)</span>
        <span class="c1"># with self._convert_sort_x(prob_sample) as x:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">prob_sample</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inverse_analytic_integrate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sample</span>

    <span class="k">def</span> <span class="nf">_fallback_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">limits</span><span class="p">):</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">zsample</span><span class="o">.</span><span class="n">accept_reject_sample</span><span class="p">(</span><span class="n">prob</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_func_to_sample_from</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span>
                                              <span class="n">prob_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                                              <span class="n">sample_and_weights_factory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sample_and_weights</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sample</span>

<div class="viewcode-block" id="BaseModel.register_additional_repr"><a class="viewcode-back" href="../../../full_api/zfit.core.basemodel.html#zfit.core.basefunc.BaseModel.register_additional_repr">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">register_additional_repr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register an additional attribute to add to the repr.</span>

<span class="sd">        Args:</span>
<span class="sd">            any keyword argument. The value has to be gettable from the instance (has to be an</span>
<span class="sd">            attribute or callable method of self.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_additional_repr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_additional_repr</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">overwritten_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_additional_repr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">overwritten_keys</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The following keys have been overwritten while registering additional repr:&quot;</span>
                          <span class="s2">&quot;</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">overwritten_keys</span><span class="p">]))</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_additional_repr</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_additional_repr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_additional_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="c1"># nice name change</span>
        <span class="n">sorted_</span> <span class="o">=</span> <span class="nb">sorted</span>
        <span class="nb">sorted</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">sorted</span>
        <span class="c1"># nice name change end</span>

        <span class="n">additional_repr</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_additional_repr</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new_obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;The attribute </span><span class="si">{}</span><span class="s2"> is not a valid attribute of this class </span><span class="si">{}</span><span class="s2">.&quot;</span>
                                     <span class="s2">&quot;Cannot use it in __repr__. It was added using the&quot;</span>
                                     <span class="s2">&quot;`register_additional_repr` function&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">new_obj</span><span class="p">):</span>
                    <span class="n">new_obj</span> <span class="o">=</span> <span class="n">new_obj</span><span class="p">()</span>
            <span class="n">additional_repr</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_obj</span>
        <span class="k">if</span> <span class="n">sorted_</span><span class="p">:</span>
            <span class="n">additional_repr</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">additional_repr</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">additional_repr</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># TODO(mayou36):repr to baseobject with _repr</span>

        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;&lt;zfit.</span><span class="si">{type_name}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot; params=[</span><span class="si">{params}</span><span class="s2">]&quot;</span>
                <span class="s2">&quot; dtype=</span><span class="si">{dtype}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">type_name</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                         <span class="n">params</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">())),</span>
                                         <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">{k}</span><span class="s2">=</span><span class="si">{v}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                                                                          <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span>
                                                                          <span class="bp">self</span><span class="o">.</span><span class="n">_get_additional_repr</span><span class="p">(</span>
                                                                              <span class="nb">sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">())))</span>

    <span class="k">def</span> <span class="nf">_check_input_x_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="c1"># TODO: signature etc?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Function </span><span class="si">{}</span><span class="s2"> is not callable.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span>

    <span class="k">def</span> <span class="nf">_get_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ztyping</span><span class="o">.</span><span class="n">DependentsType</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_extract_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_params</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">operations</span>
        <span class="k">return</span> <span class="n">operations</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">operations</span>
        <span class="k">return</span> <span class="n">operations</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">operations</span>
        <span class="k">return</span> <span class="n">operations</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">operations</span>
        <span class="k">return</span> <span class="n">operations</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="SimpleModelSubclassMixin"><a class="viewcode-back" href="../../../full_api/zfit.core.basemodel.html#zfit.core.basefunc.SimpleModelSubclassMixin">[docs]</a><span class="k">class</span> <span class="nc">SimpleModelSubclassMixin</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Subclass a model: implement the corresponding function and specify _PARAMS.</span>

<span class="sd">    In order to create a custom model, two things have to be implemented: the class attribute</span>
<span class="sd">    _PARAMS has to be a list containing the names of the parameters and the corresponding</span>
<span class="sd">    function (_unnormalized_pdf/_func) has to be overridden.</span>

<span class="sd">    Example:</span>

<span class="sd">    .. code:: python</span>

<span class="sd">        class MyPDF(zfit.pdf.ZPDF):</span>
<span class="sd">            _PARAMS = [&#39;mu&#39;, &#39;sigma&#39;]</span>

<span class="sd">            def _unnormalized_pdf(self, x):</span>
<span class="sd">                mu = self.params[&#39;mu&#39;]</span>
<span class="sd">                sigma = self.params[&#39;sigma&#39;]</span>
<span class="sd">                x = z.unstack_x(x)</span>
<span class="sd">                return z.exp(-z.square((x - mu) / sigma))</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PARAMS</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The following parameters are not given (as keyword arguments): </span><span class="si">{}</span><span class="s2">&quot;</span>
                             <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">([</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PARAMS</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">]))</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># super().__init__(params=params, *args, **kwargs)  # use if upper fails</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_check_simple_model_subclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_PARAMS</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SubclassingError</span><span class="p">(</span><span class="s2">&quot;Need to define `_PARAMS` in the definition of the subclass.&quot;</span>
                                   <span class="s2">&quot;Example:&quot;</span>
                                   <span class="s2">&quot;class MyModel(ZPDF):&quot;</span>
                                   <span class="s2">&quot;    _PARAMS = [&#39;mu&#39;, &#39;sigma&#39;]&quot;</span><span class="p">)</span>
        <span class="n">not_str</span> <span class="o">=</span> <span class="p">[</span><span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="nb">str</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">not_str</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The following parameters are not strings in `_PARAMS`: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">not_str</span><span class="p">))</span></div>
</pre></div>

              </div>
              
              
              <div class='prev-next-bottom'>
                

              </div>
              
          </main>
          

      </div>
    </div>

    
  <script src="../../../_static/js/index.3da636dd464baa7582d2.js"></script>


    <footer class="footer mt-5 mt-md-0">
  <div class="container">
    <p>
          &copy; Copyright Copyright 2018, zfit.<br/>
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.2.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>